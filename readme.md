

### 양방향 설정 


- 양방향 연관 best practice 및 로그 확인하기
- 사실 best of best 는 양방향을 쓰지 않는것 ...
- 객체의 관점에서 A.b, B.a 를 가지는건 결합이 강하고, jpa 의 양방향을 다루는 방식이 직관적이지 못함

- </br>

#### 코드


```java

@Entity
@Table(name = "BOOK")
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Book {

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	@Column(name = "BOOK_ID")
	private Long id;

	@Column(name = "NAME")
	private String name;

	@Column(name = "PRICE")
	private Long price;

	@ManyToOne
	@JoinColumn(name = "SHOP_ID")
	private Shop shop;


	@OneToMany( cascade = CascadeType.ALL)
	@JoinColumn(name = "BOOK_ID")
	private List<BookOption> options = new ArrayList<>();

	public void changeShop(Shop shop){
		this.shop = shop;
	}

	@Builder
	public Book(Long id, String name, Long price, List<BookOption> options) {
		this.id = id;
		this.name = name;
		this.price = price;
		this.options.addAll(options);
	}
}

```



</br>


```Java

@Entity
@Table(name = "SHOP")
@NoArgsConstructor
@Getter
public class Shop {

	/**
	 * 양방향 안좋아 하는데 연습용으로 ....
	 */

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	@Column(name = "SHOP_ID")
	private Long id ;

	@Column(name = "name")
	private String name;

	@Column(name = "MINIMUM_ORDER_AMOUNT")
	private Long minimumOrderAmount;

	@OneToMany(mappedBy = "shop")
	private List<Book> books = new ArrayList<>();


	public void addBook(Book book){
		book.changeShop(this);
		this.books.add(book);
	}

	@Builder
	public Shop(Long id, String name, Long minimumOrderAmount, List<Book> books) {
		this.id = id;
		this.name = name;
		this.minimumOrderAmount = minimumOrderAmount;
		this.books = books;
	}
}

```


</br>


#### 로그 

```
Hibernate: create table shop (shop_id bigint generated by default as identity, minimum_order_amount bigint, name varchar(255), primary key (shop_id))

...


create table book (book_id bigint generated by default as identity, name varchar(255), price bigint, shop_id bigint, primary key (book_id))


alter table if exists book add constraint FKnn8ggiy70jb2fxtq5ej0fuvga foreign key (shop_id) references shop

... 
```


#### 테스트 & 퀄리 확인

``` java
@Test
	public void 양방향_잇기() {

		// 1 엔티티 생성
		Shop shop = Shop.builder()
			.name("샵")
			.minimumOrderAmount(100L)
			.build();

		Book book = Book.builder()
			.name("책")
			.options(List.of())
			.price(100L)
			.build();

		Shop shop1 = shopRepository.save(shop);
		Book book1 = bookRepository.save(book);

		// 캐시 클리어 & 저장
		entityManager.flush();
		entityManager.clear();

		log.info("\n******** CACHE CLEARED  *******\n");

		// 2) 연관 잇기

		Shop shop2 = shopRepository.findById(shop1.getId()).get();
		Book book2 = bookRepository.findById(book1.getId()).get();

		shop2.addBook(book2);

		// 캐시 클리어 & 저장
		entityManager.flush();
		entityManager.clear();

		log.info("\n******** CACHE CLEARED  *******\n");

		Shop shop3 = shopRepository.findById(shop1.getId()).get();
		Book book3 = bookRepository.findById(book1.getId()).get();

		assertTrue(shop3.getBooks().get(0) == book3);

	}

```

#### hibernate log 

```text

2023-09-18T01:28:34.033+09:00 DEBUG 47159 --- [           main] org.hibernate.SQL                        : insert into shop (shop_id, minimum_order_amount, name) values (default, ?, ?)
Hibernate: insert into shop (shop_id, minimum_order_amount, name) values (default, ?, ?)
2023-09-18T01:28:34.047+09:00 DEBUG 47159 --- [           main] org.hibernate.SQL                        : insert into book (book_id, name, price, shop_id) values (default, ?, ?, ?)
Hibernate: insert into book (book_id, name, price, shop_id) values (default, ?, ?, ?)
2023-09-18T01:28:34.052+09:00  INFO 47159 --- [           main] com.dk0124.prac.ShopTest                 : 
******** CACHE CLEARED  *******

2023-09-18T01:28:34.063+09:00 DEBUG 47159 --- [           main] org.hibernate.SQL                        : select s1_0.shop_id,s1_0.minimum_order_amount,s1_0.name from shop s1_0 where s1_0.shop_id=?
Hibernate: select s1_0.shop_id,s1_0.minimum_order_amount,s1_0.name from shop s1_0 where s1_0.shop_id=?
2023-09-18T01:28:34.068+09:00 DEBUG 47159 --- [           main] org.hibernate.SQL                        : select b1_0.book_id,b1_0.name,b1_0.price,s1_0.shop_id,s1_0.minimum_order_amount,s1_0.name from book b1_0 left join shop s1_0 on s1_0.shop_id=b1_0.shop_id where b1_0.book_id=?
Hibernate: select b1_0.book_id,b1_0.name,b1_0.price,s1_0.shop_id,s1_0.minimum_order_amount,s1_0.name from book b1_0 left join shop s1_0 on s1_0.shop_id=b1_0.shop_id where b1_0.book_id=?
2023-09-18T01:28:34.075+09:00 DEBUG 47159 --- [           main] org.hibernate.SQL                        : update book set name=?, price=?, shop_id=? where book_id=?
Hibernate: update book set name=?, price=?, shop_id=? where book_id=?
2023-09-18T01:28:34.077+09:00  INFO 47159 --- [           main] com.dk0124.prac.ShopTest                 : 
******** CACHE CLEARED  *******

2023-09-18T01:28:34.077+09:00 DEBUG 47159 --- [           main] org.hibernate.SQL                        : select s1_0.shop_id,s1_0.minimum_order_amount,s1_0.name from shop s1_0 where s1_0.shop_id=?
Hibernate: select s1_0.shop_id,s1_0.minimum_order_amount,s1_0.name from shop s1_0 where s1_0.shop_id=?
2023-09-18T01:28:34.077+09:00 DEBUG 47159 --- [           main] org.hibernate.SQL                        : select b1_0.book_id,b1_0.name,b1_0.price,s1_0.shop_id,s1_0.minimum_order_amount,s1_0.name from book b1_0 left join shop s1_0 on s1_0.shop_id=b1_0.shop_id where b1_0.book_id=?
Hibernate: select b1_0.book_id,b1_0.name,b1_0.price,s1_0.shop_id,s1_0.minimum_order_amount,s1_0.name from book b1_0 left join shop s1_0 on s1_0.shop_id=b1_0.shop_id where b1_0.book_id=?
2023-09-18T01:28:34.080+09:00 DEBUG 47159 --- [           main] org.hibernate.SQL                        : select b1_0.shop_id,b1_0.book_id,b1_0.name,b1_0.price from book b1_0 where b1_0.shop_id=?
Hibernate: select b1_0.shop_id,b1_0.book_id,b1_0.name,b1_0.price from book b1_0 where b1_0.shop_id=?

```